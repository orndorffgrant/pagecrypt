<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="noindex, nofollow">
    <title>Protected Page</title>
    <style>
      :root {
        color-scheme: dark light;
        --bg-primary: #121212;
        --bg-secondary: #1e1e1e;
        --text-primary: #ffffff;
        --text-secondary: #b0b0b0;
        --accent: #4a90e2;
      }

      #page-header {
        text-align: center;
        margin-bottom: 15px;
        color: var(--text-secondary);
        font-size: 1.2rem;
        font-weight: 300;
        max-width: 100%;
        word-wrap: break-word;
        overflow-wrap: break-word;
      }

      @media (prefers-color-scheme: light) {
        :root {
          --bg-primary: #f4f4f4;
          --bg-secondary: #ffffff;
          --text-primary: #000000;
          --text-secondary: #333333;
          --accent: #2c6fad;
        }
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family:
          -apple-system,
          BlinkMacSystemFont,
          "Segoe UI",
          Roboto,
          Oxygen,
          Ubuntu,
          Cantarell,
          "Open Sans",
          "Helvetica Neue",
          sans-serif;
        background-color: var(--bg-primary);
        color: var(--text-primary);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        line-height: 1.6;
        font-size: 16px;
      }

      .container {
        background-color: var(--bg-secondary);
        border-radius: 8px;
        padding: 2rem;
        width: 100%;
        max-width: 400px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .hidden {
        display: none !important;
      }

      .spinner {
        width: 24px;
        height: 24px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: var(--accent);
        animation: spin 1s linear infinite;
        margin-right: 10px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      #pwd {
        width: 100%;
        padding: 10px;
        margin-bottom: 15px;
        border: 1px solid var(--text-secondary);
        border-radius: 4px;
        background-color: var(--bg-primary);
        color: var(--text-primary);
      }

      input[type="submit"] {
        width: 100%;
        padding: 10px;
        background-color: var(--accent);
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s;
      }

      input[type="submit"]:hover {
        opacity: 0.9;
      }

      #msg {
        color: var(--text-secondary);
        margin-bottom: 15px;
      }

      .red {
        color: #ff4444;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div id="load">
        <div class="spinner"></div>
        <p>Loading...</p>
      </div>
      <header class="hidden">
        <div id="page-header"><custom-header></custom-header></div>
        <p id="msg">This page is password protected.</p>
      </header>
      <form class="hidden">
        <input
          type="password"
          id="pwd"
          name="pwd"
          aria-label="Password"
          autofocus
        >
        <input type="submit" value="Submit">
      </form>
    </div>
    <encrypted-payload></encrypted-payload>

    <script>
      function parse(base64Str) {
        return Uint8Array.from(atob(base64Str), (c) => c.charCodeAt(0));
      }

      function find(selector) {
        const element = document.querySelector(selector);
        if (element) return element;
        throw new Error(
          `No element found with selector: "${selector}"`,
        );
      }

      const pwd = find("input");
      const header = find("header");
      const msg = find("#msg");
      const form = find("form");
      const load = find("#load");

      let salt, iv, ciphertext, iterations;

      function getKeyFromStorage() {
        const storageKey = location.pathname;
        return localStorage[storageKey] || null;
      }

      function setKeyInStorage(key) {
        const storageKey = location.pathname;
        localStorage[storageKey] = key;
      }

      function removeKeyFromStorage() {
        const storageKey = location.pathname;
        localStorage.removeItem(storageKey);
      }

      document.addEventListener("DOMContentLoaded", async () => {
        const pl = find("pre[data-i]");
        if (!pl.innerText) {
          pwd.disabled = true;
          error("No encrypted payload.");
          return;
        }
        iterations = Number(pl.dataset.i);
        const bytes = parse(pl.innerText);
        salt = bytes.slice(0, 32);
        iv = bytes.slice(32, 32 + 16);
        ciphertext = bytes.slice(32 + 16);

        if (location.hash) {
          const parts = location.href.split("#");
          pwd.value = parts[1];
        }

        if (getKeyFromStorage() || pwd.value) {
          await decrypt();
        } else {
          hide(load);
          show(form);
          header.classList.replace("hidden", "flex");
          pwd.focus();
        }
      });

      const subtle = (window.crypto && window.crypto.subtle) ||
        (window.crypto && window.crypto.webkitSubtle);

      if (!subtle) {
        error("Please use a modern browser.");
        pwd.disabled = true;
      }

      function show(element) {
        element.classList.remove("hidden");
      }

      function hide(element) {
        element.classList.add("hidden");
      }

      function error(text) {
        msg.innerText = text;
        header.classList.add("red");
      }

      form.addEventListener("submit", async (event) => {
        event.preventDefault();
        await decrypt();
      });

      async function sleep(milliseconds) {
        return new Promise((resolve) =>
          setTimeout(resolve, milliseconds)
        );
      }

      async function decrypt() {
        load.lastElementChild.innerText = "Decrypting...";
        hide(header);
        hide(form);
        show(load);
        await sleep(60);

        try {
          const decrypted = await decryptFile(
            { salt, iv, ciphertext, iterations },
            pwd.value,
          );

          document.write(decrypted);
          document.close();
        } catch (e) {
          hide(load);
          show(form);
          header.classList.replace("hidden", "flex");

          if (getKeyFromStorage()) {
            removeKeyFromStorage();
          } else {
            error("Wrong password.");
          }

          pwd.value = "";
          pwd.focus();
        }
      }

      async function deriveKey(salt, password, iterations) {
        const encoder = new TextEncoder();
        const baseKey = await subtle.importKey(
          "raw",
          encoder.encode(password),
          "PBKDF2",
          false,
          ["deriveKey"],
        );
        return await subtle.deriveKey(
          { name: "PBKDF2", salt, iterations, hash: "SHA-256" },
          baseKey,
          { name: "AES-GCM", length: 256 },
          true,
          ["decrypt"],
        );
      }

      async function decryptFile(
        { salt, iv, ciphertext, iterations },
        password,
      ) {
        const decoder = new TextDecoder();

        const keyFromStorage = getKeyFromStorage();
        const pwd = keyFromStorage ? keyFromStorage : password;
        const key = await deriveKey(salt, pwd, iterations);

        const data = new Uint8Array(
          await subtle.decrypt(
            { name: "AES-GCM", iv },
            key,
            ciphertext,
          ),
        );
        if (!data) throw "Malformed data";

        setKeyInStorage(pwd);
        location.hash = pwd;

        return decoder.decode(data);
      }
    </script>
  </body>
</html>
